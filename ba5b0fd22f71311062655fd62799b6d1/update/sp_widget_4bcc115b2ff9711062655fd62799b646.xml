<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>kb</category>
        <client_script><![CDATA[function($scope, spKBCategoryService, $timeout, $location, $rootScope, urlTools, spAriaFocusManager, spAriaUtil) {
	var c = this;
	$scope.hideCategoryWidgetInXS = (c.data.categoryId) ? true : false;
	spKBCategoryService.addDefaultListener(function(catId){
		$location.search({id: 'kb_category', kb_category: catId, kb_id: c.data.kb_id});
	});
	
	c.setCategory = function(evt, catId) {
		evt.preventDefault();
		var searchParms = $location.search();
		searchParms.kb_category = catId;
		searchParms.spa = 1;
		$location.search(searchParms);
		spKBCategoryService.setCategoryId(catId);
	};
	
	// Location change handler for back/forward buttons
	var removeLw = $rootScope.$on('$locationChangeSuccess', function(e, newUrl) {
		spAriaFocusManager.focusOnPageTitle();
		var urlParts = urlTools.parseQueryString(newUrl)
		if (urlParts.id === 'kb_category' && spKBCategoryService.getCategoryId() !== urlParts.kb_category)
			spKBCategoryService.setCategoryId(urlParts.kb_category);
	});
	
	$scope.$on('$destroy', function(){
		removeLw();
	});
	
	// Category is selected. Display articles in this category.
	$scope.categorySelected = function($event, category) {
		var elem = $($event.currentTarget);
		if (elem.attr('role') == 'treeitem')
			elem.attr('aria-selected' , true);
		else
			elem.parent().attr('aria-selected' , true);
			$timeout(function() {
				var searchParms = $location.search();
				searchParms.id = 'kb_category';
				searchParms.kb_category = category.value;
				$location.search(searchParms);
				spKBCategoryService.setCategoryId(category.value);
				spKBCategoryService.setCategorySelected(true);
			});
	};
	
	$scope.handleKeyPress = function($event, category) {
		
		// Keyboard Focus on a tree item creates a selection.
    // Up and Down arrow keys move focus and selection. Previous selections are cleared
    // Right arrow key to expand collapsed node.
    // Left arrow key to collapse expanded node.

		$event.stopPropagation();
		var currentKb = $($event.currentTarget);  // Get the current Kb category.
		var kbCategories = currentKb.closest('ul.category-list').find('.group-item');
		var index = -1;

		if(kbCategories.length > 0)
			index = kbCategories.index(currentKb);

		switch($event.which) {
			case 40: // Arrow down key.
				if(index+1 < kbCategories.length)
					handleArrowDown(index , kbCategories);
				break;
			case 38: // Arrow Up key.
				if(index > 0)
					handleArrowUp(index , kbCategories);
				break;
			case 37: // Left key.
	      handleArrowLeft($event, category, currentKb);
				break;
				
			case 39: // Right key.
				handleArrowRight($event, category, currentKb);
				break;
	 }
	};
	
	function handleArrowDown(index, kbCategories) {
	   kbCategories.get(index).setAttribute('tabindex', '-1');
		 kbCategories.get(index+1).setAttribute('tabindex', '0');
		 kbCategories.get(index+1).focus();
	}
	
	function handleArrowUp(index, kbCategories) {
		 kbCategories.get(index).setAttribute('tabindex', '-1');
		 kbCategories.get(index-1).setAttribute('tabindex', '0');
		 kbCategories.get(index-1).focus();
	}
	
	function handleArrowLeft($event, category, currentKb) {
		if(category.showChildren) {
			$scope.displayChildren($event, category);
		} else {
			var parentSubcategory = currentKb.closest('ul.sub-category-list');
			if (parentSubcategory) {
				var closestParent = parentSubcategory.parent('li').find('.group-item');
				if(closestParent && closestParent.length > 0)
					setFocus(closestParent, currentKb);
			}
		}
	}
	
	function handleArrowRight($event, category, currentKb) {
		if(category.subcategories.length === 0){
			return;
		}
		if(currentKb && !category.showChildren) {
			$scope.displayChildren($event, category);
		} else if(category.subcategories && category.subcategories.length > 0) {
		    var closestChild = currentKb.next().find('.group-item');
			  if(closestChild && closestChild.length > 0)
					setFocus(closestChild, currentKb);
		}
	}

	function setFocus(node, currentElem){
		if (node) {
			currentElem.attr('tabindex', -1);
			node.get(0).setAttribute('tabindex', 0);
			node.get(0).focus();
		}
	}
	
	//To support Show more functionality
	$scope.loadMore = function() {
		c.data.getMore = true;
		c.data.loadAllMsg = c.data.pleaseWait;
		c.data.categoriesCount = c.data.categoriesCount;
		c.server.update();
	}; 
	
	//On expanding the node, reset + to - 
	$scope.displayChildren = function($event, category) {
		$event.stopPropagation();
		category.showChildren = !category.showChildren;

		if (category.showChildren) {
			spAriaUtil.sendLiveMessage(category.label + ' '+ c.data.messages.expanded);
		} else {
			spAriaUtil.sendLiveMessage(category.label + ' ' +c.data.messages.collapsed);
		}
	};
	var listenerForBrowseCategories = $scope.$on("$sp.kb.show.categories_widget", function() {
		$scope.hideCategoryWidgetInXS = false;
	});
	$scope.$on("$destroy", function() {
		listenerForBrowseCategories();
	});
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.category-widget {
	border: 1px solid $panel-inner-border;

	[role="treeitem"] {
	    cursor: pointer;
	}
  
  .category-list {
    .fa {
      margin-right: 5px;
    }
    .text-overflow{
      overflow: auto;
      word-wrap: break-word;
    }
    .l-h-1_6x {
      line-height: 1.6em;
    }
    a {
			width: 88%;
	    display: inline-block;
    }
    .list-group {
      margin-bottom: 0;
    }
    .list-group-item {
      padding: 0;
      border: 0;
    }
    .group-item {
      padding: 10px 15px;
    }
    .group-item-default {
      &amp;:hover, &amp;:focus {
        background-color: darken($panel-default-heading-bg, 2%);
      }
    }
    .group-item-primary {
      &amp;:hover, &amp;:focus {
        background-color: lighten($panel-primary-heading-bg, 40%);
      }
    }
    .group-item-success {
      &amp;:hover {
        background-color: lighten($panel-success-heading-bg, 3%)
      }
    }
    .group-item-info {
      &amp;:hover, &amp;:focus {
        background-color: lighten($panel-info-heading-bg, 3%)
      }
    }
    .group-item-warning {
      &amp;:hover, &amp;:focus {
        background-color: $panel-warning-heading-bg
      }
    }
    .group-item-danger {
      &amp;:hover, &amp;:focus {
        background-color: lighten($panel-danger-heading-bg, 3%)
      }
    }
    
    .sub-category-list {
      .list-group-item {
        background-color: inherit;
      }
    }
    
    .list-bg-default {
        border-left: 15px solid $panel-default-heading-bg;
      }
      .list-bg-primary {
        border-left: 15px solid lighten($panel-primary-heading-bg, 43%);
      }
      .list-bg-success {
        border-left: 15px solid lighten($panel-success-heading-bg, 6%);
      }
      .list-bg-info {
        border-left: 15px solid lighten($panel-info-heading-bg, 6%);
      }
      .list-bg-warning {
        border-left: 15px solid lighten($panel-warning-heading-bg, 3%);
      }
      .list-bg-danger {
        border-left: 15px solid lighten($panel-danger-heading-bg, 6%);
      }
    
    .list-bg-default {
      background-color: $panel-default-heading-bg;
    }
    .list-bg-primary {
      background-color: lighten($panel-primary-heading-bg, 43%);
    }
    .list-bg-success {
      background-color: lighten($panel-success-heading-bg, 6%);
    }
    .list-bg-info {
      background-color: lighten($panel-info-heading-bg, 6%);
    }
    .list-bg-warning {
      background-color: lighten($panel-warning-heading-bg, 3%);
    }
    .list-bg-danger {
      background-color: lighten($panel-danger-heading-bg, 6%);
    }
  }
}
.panel-primary .badge {
  background-color: $panel-primary-heading-bg;
  color: white;
}
.panel-default .badge {
  background-color: $panel-default-text;
  color: white
}
.panel-success .badge {
  background-color:  $panel-success-text;
  color: white;
}
.panel-info .badge {
  background-color: $panel-info-text;
  color: white;
}
.panel-warning .badge {
  background-color: $panel-warning-text;
  color: white;
}
.panel-danger .badge {
  background-color: $panel-danger-text;
  color: white;
}
.category-list .badge {
  text-align: right;
}
.text-default {
  color: $text-muted;
}
.label-as-badge {
	padding: .35em .6em .3em;
}

.panel {
  color: $inherit;
}

.category-list {
  span.badge {
    background-color: $primary;
    color: $color-lightest;
  }
  span.list-group-item {
    border: inherit;
  }
  span.list-group-item:hover {
	background: $body-bg;
  }
} 

.text-default {
  color: $primary;
}

@media screen and (max-width: 843px) {
  .panel-heading i.fa{
     display: none;
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list>color,title</field_list>
        <has_preview>false</has_preview>
        <id>mvn_kb_knowledge_categories</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>MultiverseNow KB Categories - KBv3</name>
        <option_schema>[{"hint":"Number of categories to load on page load","name":"number_of_categories_to_load","section":"Data","default_value":"15","label":"Number of top-level categories to load (default 15). Higher values can impact performance.","type":"integer"},{"name":"omit_badges","section":"Behavior","label":"Omit badge counts (can improve performance for large categories)","type":"boolean"},{"name":"check_access_per_category","section":"Data","default_value":"0","label":"Max number of articles evaluated per category to determine visibility. Zero means all categories are visible if user has access to the Knowledge Base. Higher values can impact performance.","type":"string"},{"name":"max_article_limit_for_counts","section":"Data","default_value":"500","label":"Max article limit to allow category counts - if number of articles in configured Knowledge Bases exceeds this limit, category counts are not calculated. Higher values can impact performance.","type":"string"}]</option_schema>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
	
	//Get Knowledge Base Id. If knowledge base is not selected, get knowledge bases associated with portal.
	data.kb = "";
	data.kb_id = $sp.getParameter("kb_id");
	gs.info("The Knowlege Parameter is: " + data.kb_id);
	data.show = false;
	if (data.kb_id) {
		var kbArr = [];
		var kbGR = new GlideRecord("kb_knowledge_base");
		kbGR.addQuery("sys_id", "IN", data.kb_id);
		kbGR.query();
		while (kbGR.next()) {
			if (kbGR.canRead())
				kbArr.push(kbGR.getUniqueValue());
		}
		data.kb = String(kbArr);
		gs.info("The Knowlege Base being accessed is: " + data.kb);
	} else
		data.kb = String($sp.getKnowledgeBases());
		gs.info("The Knowlege Base being accessed is: " + data.kb);
	
	//To support Show more functionality
	var loadCategories = options.number_of_categories_to_load || 15;
	data.showMoreMsg = gs.getMessage("Show More");
	data.pleaseWait = gs.getMessage("Please wait... fetching categories");

	var maxArticleLimitForCounts = parseInt(options.max_article_limit_for_counts) || 500;
	var articles = new GlideRecord("kb_knowledge");
	articles.addQuery("kb_knowledge_base", "IN", data.kb);
	articles.addQuery("workflow_state", "published");
	articles.addQuery("valid_to", ">=", new GlideDate().getValue());
	articles.addActiveQuery();
	articles.setLimit(maxArticleLimitForCounts);
	articles.query();

	var kbCount = articles.getRowCount();

  // Get all top-level categories in selected knowledge bases
	var cats = new GlideRecord("kb_category");
	cats.addActiveQuery();
	cats.addQuery("parent_id",'IN', data.kb);
	cats.orderBy('label');
	cats.query();
	
	var categoryId = $sp.getParameter('kb_category');
	var msg = data.messages = {};
	msg.expanded = gs.getMessage("Expanded");
	msg.collapsed = gs.getMessage("Collapsed");

	data.category = {};
	data.categories = [];
  
	//To support Show more functionality
	if (input && input.getMore)
	    loadCategories = loadCategories + parseInt(input.categoriesCount);

	var categoriesCount = 0;
  
	// Get Subcategories and build tree structure
	while (cats.next()) {
	    var categoryDetails = getCategory(cats, 0);
	    data.categories.push(categoryDetails);

		  //To support Show more functionality
		  if (categoryDetails.count != 0)
		      categoriesCount++;
		  if (categoriesCount >= loadCategories)
			    break;
	}
	
  data.showMore = cats.hasNext();
	data.categoriesCount = categoriesCount;
	data.loadAllMsg = gs.getMessage("Showing {0} categories", [categoriesCount + ""]); 
	data.categoryId = categoryId;
	
	if (data.categoriesCount > 0) {
		data.categories[0].isFirstCategory = true;
	}
	
	options.check_access_per_category = parseInt(options.check_access_per_category);

	function getCategory(cats, level) {
		var categoryDetails = {};
		var articleCount = -1;
		var arts;
		
		if (kbCount < maxArticleLimitForCounts) {
			// small KB, get full canRead counts for each category
			arts = $sp.getKBCategoryArticleSummary(cats.getUniqueValue(), 0, 0);
			articleCount = arts.length;
			if (articleCount > 0)
				data.show = true;
		} else if (options.check_access_per_category > 0) {
			// large KB, don't get counts but check first N articles for read access to category
			arts = $sp.getKBCategoryArticleSummary(cats.getUniqueValue(), options.check_access_per_category, 0);
			if (arts.length > 0)
				data.show = true;
			else
				articleCount = 0; // nothing to see here, no visible article found
				gs.info("Could not find any article.");
		} else {
			// large KB, not checking article access before showing category, preserves legacy behavior
			data.show = true;
		}
		
		categoryDetails.label = cats.getDisplayValue("label");
		categoryDetails.value = cats.getUniqueValue();
		categoryDetails.count = articleCount;
		categoryDetails.showChildren = (cats.sys_id == categoryId);
		categoryDetails.level = level;
		
		var subcategories = new GlideRecord("kb_category");	
		subcategories = $sp.getSubCategories(cats.getUniqueValue());
		categoryDetails.subcategories = [];
		while (subcategories.next()) {
			var category = getCategory(subcategories, level+1);
			if (category.count != 0) {
				categoryDetails.subcategories.push(category);
				categoryDetails.count += category.count;
			}
			categoryDetails.showChildren = categoryDetails.showChildren || category.showChildren;
		}
		return categoryDetails;
	}
})()
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-10-15 17:12:06</sys_created_on>
        <sys_id>4bcc115b2ff9711062655fd62799b646</sys_id>
        <sys_mod_count>8</sys_mod_count>
        <sys_name>MultiverseNow KB Categories - KBv3</sys_name>
        <sys_package display_value="MultiverseNow" source="x_903520_rpg">ba5b0fd22f71311062655fd62799b6d1</sys_package>
        <sys_policy/>
        <sys_scope display_value="MultiverseNow">ba5b0fd22f71311062655fd62799b6d1</sys_scope>
        <sys_update_name>sp_widget_4bcc115b2ff9711062655fd62799b646</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-10-15 19:51:39</sys_updated_on>
        <template><![CDATA[<section aria-label="${Knowledge categories}">
  <div ng-if="::(data.show != true)">
    ${No categories available}
  </div>
  <div ng-show="data.kb" ng-class="{'hidden-xs' : hideCategoryWidgetInXS}" class="panel panel-{{::c.options.color}} category-widget no-border" ng-if="::(data.show == true)">
    <div class="panel-heading">
      <h2 class="h4 panel-title" ng-bind="::c.options.title" id="kb_categories_title"></h2>
    </div>
    <ul class="list-group category-list" role="tree" aria-labelledby="kb_categories_title">
      <li role="{{category.subcategories.length > 0 ? 'treeitem' : 'presentation'}}"
          class="list-group-item text-overflow" 
          ng-include="'kbv3-category-template.html'" 
          ng-attr-aria-expanded="{{category.subcategories.length > 0 ? category.showChildren : undefined}}"
          ng-attr-aria-selected="{{category.subcategories.length > 0 ? category.value == c.data.categoryId : undefined}}"
          ng-repeat="category in c.data.categories track by category.value "
          ng-if="category.count != 0">
      </li>
    </ul>
    <div class="panel-footer text-center" ng-if="data.showMore">
      <a href="javascript:void(0)" role="button" class="text-center" ng-click="loadMore()" >{{::data.showMoreMsg}}</a>
      <div class="text-muted text-center" role="status">
        {{data.loadAllMsg}}
      </div>
    </div>
  </div>
</section>

<script type="text/ng-template" id="kbv3-category-template.html">
  	<div ng-click="categorySelected($event, category)"
         ng-attr-tabindex="{{category.value == c.data.categoryId || (!c.data.categoryId && category.isFirstCategory) ? '0' : undefined}}"  
         ng-keydown="handleKeyPress($event, category)"
         sn-focus="category.value == c.data.categoryId"
		 ng-enabled="category.count != 0"
         role="treeitem"
         ng-attr-aria-selected="{{category.subcategories.length == 0 ? category.value == c.data.categoryId : undefined}}"
         aria-label="{{category.showChildren? '${Expanded category} ' + category.label : '${Collapsed category} ' + category.label}}"
         class="group-item group-item-{{::options.color}}">
      <i ng-if="::category.subcategories.length > 0" 
      	  class="l-h-1_6x pull-left fa" 
          ng-class="{true: 'fa-minus-square-o', false: 'fa-plus-square-o'}[category.showChildren]" 
          ng-click="displayChildren($event, category)"
          role="presentation"/></i>
      <span  ng-if="category.count > 0 && options.omit_badges != 'true'"  class="badge pull-right pointer">{{::category.count}}</span>
      <span class="block text-overflow category" 
          ng-class="{true: 'text-{{::options.color}}', false: ''}[category.value == c.data.categoryId]"
          id="{{::category.value}}">
          {{::category.label}}
          <span class="sr-only">${items}</span>
      </span>
    </div>
  	<ul class="list-group sub-category-list list-bg-{{::options.color}}" 
    		aria-label="{{category.label}} ${subcategories}" 
        role="group"
    		ng-if="category.showChildren && category.subcategories.length >0"  
        ng-class="{true: 'no-indent', false: ''}[category.level > 2]"> 
      <li role="{{category.subcategories.length > 0 ? 'treeitem' : 'presentation'}}" 
      		class="list-group-item text-overflow" 
          ng-include="'kbv3-category-template.html'"
          ng-attr-aria-expanded="{{category.subcategories.length > 0 ? category.showChildren : undefined}}"
          ng-attr-aria-selected="{{category.subcategories.length > 0 ? category.value == c.data.categoryId : undefined}}"
          ng-repeat="category in category.subcategories | orderBy: 'label' track by category.value " 
          ng-if="category.count != 0">
      </li>
  	</ul>
</script>]]></template>
    </sp_widget>
</record_update>
